Copied from Custom Processing Unit