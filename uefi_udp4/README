This code is heavily inspired from https://github.com/rust-osdev/uefi-rs/pull/1130/files
